name: Deploy to Oracle Cloud

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # IMAGE_NAME will be set dynamically to ensure lowercase

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install app dependencies
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install testing dependencies
          pip install pytest pytest-asyncio

      - name: Run Tests
        run: |
          # Debug: List files
          ls -R
          # Add the bot directory to PYTHONPATH so tests can find the modules
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest -vv tests/

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Downcase REPO
        run: |
          echo "REPO_LC=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.REPO_LC }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Create dummy .env file
        run: |
          echo "DISCORD_BOT_TOKEN=dummy" >> .env
          echo "TMDB_API_KEY=dummy" >> .env
          echo "ALPHA_VANTAGE_API_KEY=dummy" >> .env
          echo "OPENWEATHERMAP_API_KEY=dummy" >> .env
          echo "GEMINI_API_KEY=dummy" >> .env

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # Context must be the subdirectory where Dockerfile and code exist
          context: .
          file: bot.Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Downcase REPO
        run: |
          echo "REPO_LC=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      # Avoid Docker-based ssh actions (they can fail building/pulling on runners).
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.OCI_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.OCI_HOST }}" >> ~/.ssh/known_hosts

      - name: Create .env file from secret
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE }}
        run: |
          # Preserve content exactly (including newlines)
          printf '%s' "$ENV_FILE_CONTENT" > .env

      - name: Copy .env to server
        run: |
          scp .env "${{ secrets.OCI_USERNAME }}@${{ secrets.OCI_HOST }}:~/.env"

      - name: Deploy over SSH (no action container)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE: ${{ env.REGISTRY }}/${{ env.REPO_LC }}:latest
          ACTOR: ${{ github.actor }}
        run: |
          # Pipe token via stdin so it never needs to exist as a remote env var.
          # REGISTRY/IMAGE/ACTOR expand locally; $HOME expands remotely.
          printf '%s' "$GITHUB_TOKEN" | ssh "${{ secrets.OCI_USERNAME }}@${{ secrets.OCI_HOST }}" "bash -lc 'set -euo pipefail
          docker login \"$REGISTRY\" -u \"$ACTOR\" --password-stdin
          docker pull \"$IMAGE\"
          docker stop bot-container || true
          docker rm bot-container || true
          mkdir -p \"\$HOME/data\"
          docker run -d \
            --name bot-container \
            --restart unless-stopped \
            -p 5000:5000 \
            -v \"\$HOME/data:/app/data\" \
            --env-file \"\$HOME/.env\" \
            \"$IMAGE\"
          docker image prune -f
          '"

